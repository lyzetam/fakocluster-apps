<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name"> | My New Hugo Site</title>
<meta property="og:title" content=" | My New Hugo Site" />
<meta name="twitter:title" content=" | My New Hugo Site" />
<meta itemprop="name" content=" | My New Hugo Site" />
<meta name="application-name" content=" | My New Hugo Site" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />

  <link rel="alternate" hreflang="en" href="http://localhost:1313/pages/services/postgres-cluster/readme/" title="" />






<meta name="generator" content="Hugo 0.148.2">

    
    <meta property="og:url" content="http://localhost:1313/pages/services/postgres-cluster/readme/">
  <meta property="og:site_name" content="My New Hugo Site">
  <meta property="og:title" content="My New Hugo Site">
  <meta property="og:description" content="PostgreSQL Cluster Service Overview The PostgreSQL Cluster is a highly available database service deployed using CloudNative PG (CNPG) operator. It provides a 3-node PostgreSQL 16.2 cluster with automatic failover, backup scheduling, and secure credential management through AWS Secrets Manager. This cluster serves as the primary database backend for multiple services including Keycloak, N8N, and other applications.
Key Features High Availability: 3-node cluster with automatic failover Automated Backups: Daily scheduled backups at 2 AM Secure Credentials: Integration with AWS Secrets Manager Connection Pooling: PgBouncer pooler for efficient connections Performance Tuned: Optimized PostgreSQL parameters Pod Anti-Affinity: Instances spread across different nodes Monitoring Ready: Prometheus metrics support Architecture Components Cluster: 3 PostgreSQL instances (1 primary, 2 replicas) Operator: CloudNative PG operator manages the cluster Storage: 50Gi persistent volume per instance Pooler: PgBouncer connection pooler Backup: Scheduled backup with retention policy External Secrets: AWS Secrets Manager integration Resource Requirements Memory: 2Gi (request), 4Gi (limit) per instance CPU: 1 core (request), 2 cores (limit) per instance Storage: 50Gi per instance (150Gi total) Storage Class: nfs-postgres-v2 Configuration PostgreSQL Parameters Parameter Value Description max_connections 200 Maximum concurrent connections shared_buffers 512MB Memory for caching data effective_cache_size 3GB Planner’s assumption about cache work_mem 8MB Memory for query operations wal_buffers 16MB WAL write buffer size maintenance_work_mem 64MB Memory for maintenance operations max_wal_size 1GB Maximum WAL size before checkpoint checkpoint_timeout 5min Time between checkpoints Network Access The cluster allows connections from:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="pages">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="My New Hugo Site">
  <meta name="twitter:description" content="PostgreSQL Cluster Service Overview The PostgreSQL Cluster is a highly available database service deployed using CloudNative PG (CNPG) operator. It provides a 3-node PostgreSQL 16.2 cluster with automatic failover, backup scheduling, and secure credential management through AWS Secrets Manager. This cluster serves as the primary database backend for multiple services including Keycloak, N8N, and other applications.
Key Features High Availability: 3-node cluster with automatic failover Automated Backups: Daily scheduled backups at 2 AM Secure Credentials: Integration with AWS Secrets Manager Connection Pooling: PgBouncer pooler for efficient connections Performance Tuned: Optimized PostgreSQL parameters Pod Anti-Affinity: Instances spread across different nodes Monitoring Ready: Prometheus metrics support Architecture Components Cluster: 3 PostgreSQL instances (1 primary, 2 replicas) Operator: CloudNative PG operator manages the cluster Storage: 50Gi persistent volume per instance Pooler: PgBouncer connection pooler Backup: Scheduled backup with retention policy External Secrets: AWS Secrets Manager integration Resource Requirements Memory: 2Gi (request), 4Gi (limit) per instance CPU: 1 core (request), 2 cores (limit) per instance Storage: 50Gi per instance (150Gi total) Storage Class: nfs-postgres-v2 Configuration PostgreSQL Parameters Parameter Value Description max_connections 200 Maximum concurrent connections shared_buffers 512MB Memory for caching data effective_cache_size 3GB Planner’s assumption about cache work_mem 8MB Memory for query operations wal_buffers 16MB WAL write buffer size maintenance_work_mem 64MB Memory for maintenance operations max_wal_size 1GB Maximum WAL size before checkpoint checkpoint_timeout 5min Time between checkpoints Network Access The cluster allows connections from:">


    

    <link rel="canonical" href="http://localhost:1313/pages/services/postgres-cluster/readme/">
    <link href="/style.min.e390ba7da26222f4dc42a349955d76dbbe44e5ce2535a43de5a70633a0a9ec3c.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        About
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/projects/">
                        Projects
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/secondbrain/">
                        Second Brain
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title"></h1>
                
                
            </header>
            
            <div class="page-content">
                <h1 id="postgresql-cluster-service">PostgreSQL Cluster Service</h1>
<h2 id="overview">Overview</h2>
<p>The PostgreSQL Cluster is a highly available database service deployed using CloudNative PG (CNPG) operator. It provides a 3-node PostgreSQL 16.2 cluster with automatic failover, backup scheduling, and secure credential management through AWS Secrets Manager. This cluster serves as the primary database backend for multiple services including Keycloak, N8N, and other applications.</p>
<h2 id="key-features">Key Features</h2>
<ul>
<li><strong>High Availability</strong>: 3-node cluster with automatic failover</li>
<li><strong>Automated Backups</strong>: Daily scheduled backups at 2 AM</li>
<li><strong>Secure Credentials</strong>: Integration with AWS Secrets Manager</li>
<li><strong>Connection Pooling</strong>: PgBouncer pooler for efficient connections</li>
<li><strong>Performance Tuned</strong>: Optimized PostgreSQL parameters</li>
<li><strong>Pod Anti-Affinity</strong>: Instances spread across different nodes</li>
<li><strong>Monitoring Ready</strong>: Prometheus metrics support</li>
</ul>
<h2 id="architecture">Architecture</h2>
<h3 id="components">Components</h3>
<ol>
<li><strong>Cluster</strong>: 3 PostgreSQL instances (1 primary, 2 replicas)</li>
<li><strong>Operator</strong>: CloudNative PG operator manages the cluster</li>
<li><strong>Storage</strong>: 50Gi persistent volume per instance</li>
<li><strong>Pooler</strong>: PgBouncer connection pooler</li>
<li><strong>Backup</strong>: Scheduled backup with retention policy</li>
<li><strong>External Secrets</strong>: AWS Secrets Manager integration</li>
</ol>
<h3 id="resource-requirements">Resource Requirements</h3>
<ul>
<li><strong>Memory</strong>: 2Gi (request), 4Gi (limit) per instance</li>
<li><strong>CPU</strong>: 1 core (request), 2 cores (limit) per instance</li>
<li><strong>Storage</strong>: 50Gi per instance (150Gi total)</li>
<li><strong>Storage Class</strong>: <code>nfs-postgres-v2</code></li>
</ul>
<h2 id="configuration">Configuration</h2>
<h3 id="postgresql-parameters">PostgreSQL Parameters</h3>
<table>
  <thead>
      <tr>
          <th>Parameter</th>
          <th>Value</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>max_connections</code></td>
          <td><code>200</code></td>
          <td>Maximum concurrent connections</td>
      </tr>
      <tr>
          <td><code>shared_buffers</code></td>
          <td><code>512MB</code></td>
          <td>Memory for caching data</td>
      </tr>
      <tr>
          <td><code>effective_cache_size</code></td>
          <td><code>3GB</code></td>
          <td>Planner&rsquo;s assumption about cache</td>
      </tr>
      <tr>
          <td><code>work_mem</code></td>
          <td><code>8MB</code></td>
          <td>Memory for query operations</td>
      </tr>
      <tr>
          <td><code>wal_buffers</code></td>
          <td><code>16MB</code></td>
          <td>WAL write buffer size</td>
      </tr>
      <tr>
          <td><code>maintenance_work_mem</code></td>
          <td><code>64MB</code></td>
          <td>Memory for maintenance operations</td>
      </tr>
      <tr>
          <td><code>max_wal_size</code></td>
          <td><code>1GB</code></td>
          <td>Maximum WAL size before checkpoint</td>
      </tr>
      <tr>
          <td><code>checkpoint_timeout</code></td>
          <td><code>5min</code></td>
          <td>Time between checkpoints</td>
      </tr>
  </tbody>
</table>
<h3 id="network-access">Network Access</h3>
<p>The cluster allows connections from:</p>
<ul>
<li><code>10.0.0.0/8</code> - Kubernetes pod network</li>
<li><code>172.16.0.0/12</code> - Docker networks</li>
<li><code>192.168.0.0/16</code> - Local networks</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="connection-details">Connection Details</h3>
<h4 id="primary-readwrite">Primary (Read/Write)</h4>
<pre tabindex="0"><code>Host: postgres-cluster-rw.postgres.svc.cluster.local
Port: 5432
Database: app (or specify your database)
SSL: Enabled
</code></pre><h4 id="read-only-replicas">Read-Only Replicas</h4>
<pre tabindex="0"><code>Host: postgres-cluster-ro.postgres.svc.cluster.local
Port: 5432
</code></pre><h4 id="any-instance-load-balanced">Any Instance (Load Balanced)</h4>
<pre tabindex="0"><code>Host: postgres-cluster-r.postgres.svc.cluster.local
Port: 5432
</code></pre><h3 id="connection-pooler">Connection Pooler</h3>
<p>For applications requiring connection pooling:</p>
<pre tabindex="0"><code>Host: postgres-cluster-pooler-rw.postgres.svc.cluster.local
Port: 5432
</code></pre><h3 id="creating-a-database">Creating a Database</h3>
<ol>
<li><strong>Connect as superuser</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl exec -it -n postgres postgres-cluster-1 -- psql -U postgres
</span></span></code></pre></div><ol start="2">
<li><strong>Create database and user</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> myapp;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">USER</span> myapp_user <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">ENCRYPTED</span> PASSWORD <span style="color:#e6db74">&#39;secure_password&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">PRIVILEGES</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DATABASE</span> myapp <span style="color:#66d9ef">TO</span> myapp_user;
</span></span></code></pre></div><h3 id="using-aws-secrets-manager">Using AWS Secrets Manager</h3>
<p>Credentials are stored in AWS Secrets Manager:</p>
<ul>
<li><strong>Admin credentials</strong>: <code>postgres/admin-credentials</code></li>
<li><strong>App user credentials</strong>: <code>postgres/app-credentials</code></li>
</ul>
<p>Format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;postgres&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;secure_password&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="operations">Operations</h2>
<h3 id="checking-cluster-status">Checking Cluster Status</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Check cluster status</span>
</span></span><span style="display:flex;"><span>kubectl get cluster -n postgres
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Detailed cluster information</span>
</span></span><span style="display:flex;"><span>kubectl describe cluster postgres-cluster -n postgres
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check pod status</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n postgres -l postgresql<span style="color:#f92672">=</span>postgres-cluster
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># View cluster events</span>
</span></span><span style="display:flex;"><span>kubectl get events -n postgres --field-selector involvedObject.name<span style="color:#f92672">=</span>postgres-cluster
</span></span></code></pre></div><h3 id="monitoring-replication">Monitoring Replication</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Check replication status</span>
</span></span><span style="display:flex;"><span>kubectl exec -n postgres postgres-cluster-1 -- psql -U postgres -c <span style="color:#e6db74">&#34;SELECT * FROM pg_stat_replication;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check replication lag</span>
</span></span><span style="display:flex;"><span>kubectl exec -n postgres postgres-cluster-2 -- psql -U postgres -c <span style="color:#e6db74">&#34;SELECT pg_last_wal_receive_lsn() - pg_last_wal_replay_lsn() AS lag;&#34;</span>
</span></span></code></pre></div><h3 id="manual-failover">Manual Failover</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Promote a specific instance to primary</span>
</span></span><span style="display:flex;"><span>kubectl cnpg promote postgres-cluster-2 -n postgres
</span></span></code></pre></div><h3 id="backup-management">Backup Management</h3>
<h4 id="list-backups">List Backups</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get backups -n postgres
</span></span></code></pre></div><h4 id="trigger-manual-backup">Trigger Manual Backup</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: postgresql.cnpg.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Backup
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: postgres-cluster-manual-$(date +%Y%m%d%H%M%S)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: postgres
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: postgres-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h4 id="restore-from-backup">Restore from Backup</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Create a new cluster from backup</span>
</span></span><span style="display:flex;"><span>kubectl apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: postgresql.cnpg.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: postgres-cluster-restored
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: postgres
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # ... other specs ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  bootstrap:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    recovery:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      backup:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: &lt;backup-name&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="cluster-not-starting">Cluster Not Starting</h3>
<ol>
<li><strong>Check operator logs</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl logs -n cnpg-system deployment/cnpg-controller-manager
</span></span></code></pre></div><ol start="2">
<li><strong>Check instance logs</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl logs -n postgres postgres-cluster-1
</span></span></code></pre></div><ol start="3">
<li><strong>Verify secrets</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secrets -n postgres
</span></span><span style="display:flex;"><span>kubectl describe externalsecret -n postgres
</span></span></code></pre></div><h3 id="connection-issues">Connection Issues</h3>
<ol>
<li><strong>Test connectivity</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl run -it --rm psql-test --image<span style="color:#f92672">=</span>postgres:16 --restart<span style="color:#f92672">=</span>Never -- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  psql -h postgres-cluster-rw.postgres.svc.cluster.local -U postgres -d postgres
</span></span></code></pre></div><ol start="2">
<li><strong>Check service endpoints</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get endpoints -n postgres
</span></span></code></pre></div><ol start="3">
<li><strong>Verify network policies</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get networkpolicies -n postgres
</span></span></code></pre></div><h3 id="performance-issues">Performance Issues</h3>
<ol>
<li><strong>Check resource usage</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl top pods -n postgres
</span></span></code></pre></div><ol start="2">
<li><strong>View slow queries</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> query, calls, mean_exec_time, total_exec_time
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_stat_statements
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> mean_exec_time <span style="color:#66d9ef">DESC</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></div><ol start="3">
<li><strong>Check connection count</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">FROM</span> pg_stat_activity;
</span></span></code></pre></div><h3 id="storage-issues">Storage Issues</h3>
<ol>
<li><strong>Check PVC status</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pvc -n postgres
</span></span></code></pre></div><ol start="2">
<li><strong>Monitor disk usage</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl exec -n postgres postgres-cluster-1 -- df -h /var/lib/postgresql/data
</span></span></code></pre></div><h2 id="performance-tuning">Performance Tuning</h2>
<h3 id="query-optimization">Query Optimization</h3>
<ol>
<li><strong>Enable query statistics</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> EXTENSION <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> pg_stat_statements;
</span></span></code></pre></div><ol start="2">
<li><strong>Analyze tables regularly</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ANALYZE</span>;
</span></span></code></pre></div><ol start="3">
<li><strong>Monitor index usage</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> schemaname, tablename, indexname, idx_scan
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_stat_user_indexes
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> idx_scan;
</span></span></code></pre></div><h3 id="connection-pool-tuning">Connection Pool Tuning</h3>
<p>Edit pooler configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># In pooler.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pgbouncer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">poolMode</span>: <span style="color:#ae81ff">transaction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_client_conn</span>: <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default_pool_size</span>: <span style="color:#e6db74">&#34;25&#34;</span>
</span></span></code></pre></div><h3 id="resource-optimization">Resource Optimization</h3>
<p>For write-heavy workloads:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">postgresql</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">wal_buffers</span>: <span style="color:#e6db74">&#34;32MB&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">checkpoint_segments</span>: <span style="color:#e6db74">&#34;32&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">checkpoint_completion_target</span>: <span style="color:#e6db74">&#34;0.9&#34;</span>
</span></span></code></pre></div><h2 id="security-considerations">Security Considerations</h2>
<h3 id="authentication">Authentication</h3>
<ul>
<li>Superuser credentials in AWS Secrets Manager</li>
<li>MD5 authentication for network connections</li>
<li>SSL/TLS enabled by default</li>
</ul>
<h3 id="network-security">Network Security</h3>
<ul>
<li>Pod-to-pod communication only</li>
<li>Network policies recommended</li>
<li>No external exposure by default</li>
</ul>
<h3 id="backup-security">Backup Security</h3>
<ul>
<li>Backups inherit cluster RBAC</li>
<li>Consider encryption at rest</li>
<li>Regular backup testing recommended</li>
</ul>
<h3 id="best-practices">Best Practices</h3>
<ol>
<li><strong>Regular password rotation</strong></li>
<li><strong>Audit logging enabled</strong></li>
<li><strong>Principle of least privilege</strong></li>
<li><strong>Connection limits per user</strong></li>
<li><strong>Regular security updates</strong></li>
</ol>
<h2 id="monitoring">Monitoring</h2>
<h3 id="key-metrics">Key Metrics</h3>
<ul>
<li>Replication lag</li>
<li>Connection pool saturation</li>
<li>Query response times</li>
<li>Disk I/O and space usage</li>
<li>CPU and memory utilization</li>
<li>Transaction rate</li>
<li>Cache hit ratio</li>
</ul>
<h3 id="prometheus-queries">Prometheus Queries</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-promql" data-lang="promql"><span style="display:flex;"><span><span style="color:#75715e"># Replication lag</span>
</span></span><span style="display:flex;"><span>pg_replication_lag_seconds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Active connections</span>
</span></span><span style="display:flex;"><span>pg_stat_activity_count
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Database size</span>
</span></span><span style="display:flex;"><span>pg_database_size_bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Transaction rate</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">rate</span><span style="color:#f92672">(</span>pg_stat_database_xact_commit[<span style="color:#e6db74">5m</span>]<span style="color:#f92672">)</span>
</span></span></code></pre></div><h3 id="grafana-dashboard">Grafana Dashboard</h3>
<p>Import dashboard ID: 9628 (PostgreSQL Database)</p>
<h2 id="maintenance">Maintenance</h2>
<h3 id="regular-tasks">Regular Tasks</h3>
<ol>
<li>
<p><strong>Weekly</strong>:</p>
<ul>
<li>Check backup completion</li>
<li>Review slow query log</li>
<li>Analyze tables</li>
</ul>
</li>
<li>
<p><strong>Monthly</strong>:</p>
<ul>
<li>Review connection pool settings</li>
<li>Check index usage</li>
<li>Update statistics</li>
</ul>
</li>
<li>
<p><strong>Quarterly</strong>:</p>
<ul>
<li>PostgreSQL version updates</li>
<li>Security audit</li>
<li>Performance baseline review</li>
</ul>
</li>
</ol>
<h3 id="upgrade-procedure">Upgrade Procedure</h3>
<ol>
<li><strong>Test in staging</strong></li>
<li><strong>Backup production</strong></li>
<li><strong>Update image version</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imageName</span>: <span style="color:#ae81ff">ghcr.io/cloudnative-pg/postgresql:16.3</span>
</span></span></code></pre></div><ol start="4">
<li><strong>Monitor rolling update</strong></li>
</ol>
<h2 id="integration-examples">Integration Examples</h2>
<h3 id="application-connection-string">Application Connection String</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Python with psycopg2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> psycopg2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>conn <span style="color:#f92672">=</span> psycopg2<span style="color:#f92672">.</span>connect(
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;postgres-cluster-pooler-rw.postgres.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>    database<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;myapp&#34;</span>,
</span></span><span style="display:flex;"><span>    user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;myapp_user&#34;</span>,
</span></span><span style="display:flex;"><span>    password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;from_secret&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="spring-boot-configuration">Spring Boot Configuration</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">datasource</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:postgresql://postgres-cluster-pooler-rw.postgres.svc.cluster.local:5432/myapp</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">username</span>: <span style="color:#ae81ff">${DB_USER}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">password</span>: <span style="color:#ae81ff">${DB_PASSWORD}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hikari</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maximum-pool-size</span>: <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><h2 id="future-improvements">Future Improvements</h2>
<ul>
<li><input disabled="" type="checkbox"> Implement automated backup testing</li>
<li><input disabled="" type="checkbox"> Add pgAudit for compliance logging</li>
<li><input disabled="" type="checkbox"> Configure streaming replication to DR site</li>
<li><input disabled="" type="checkbox"> Implement automatic VACUUM scheduling</li>
<li><input disabled="" type="checkbox"> Add TimescaleDB extension for time-series data</li>
<li><input disabled="" type="checkbox"> Create backup retention lifecycle policies</li>
<li><input disabled="" type="checkbox"> Implement connection pool per application</li>
<li><input disabled="" type="checkbox"> Add read replica auto-scaling</li>
</ul>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
</div>
    <small class="footer_copyright">
        © 2025 .
        
    </small>
</footer>







    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
